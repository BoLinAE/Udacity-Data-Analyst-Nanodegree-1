---
title: "Exploratory Data Analysis"
author: "Will Koehrsen"
date: "April 9, 2017"
output: html_document
---
# Introduction to Dataset

I wanted to choose a dataset that was both relatable and could potentially be used to make smarter decisions. Therefore, I decided to work with [medical appointment no shows data available on Kaggle](https://www.kaggle.com/joniarroba/noshowappointments). This dataset is drawn from 300,000 patient visits in Brazil. I wanted to see what factors of an appointment were most strongly correlated with whether or not a patient would show up to their appointment. 
There were a total of 14 variables I included from the original data. The variables are as follows

1. __Age__: integer age of patient
2. __Gender__: M or F
3. __AppointmentReservationDate__: date and time appointment was made
4. __AppointmentDate__: date of appointment without time
5. __DayOfTheWeek__: day of the week of appointment
6. __Status__: Show-up or No-Show
7. __Diabetes__: 0 or 1 for condition
8. __Alcoholism__: 0 or 1 for condition
9. __Hypertension__: 0 or 1 for condition
10. __Smoker__: 0 or 1 for smoker / non-smoker
11. __Scholarship__: 0 or 1 indicating whether the family of the patient takes part in the [Bolsa Familia Program](http://www.worldbank.org/en/news/opinion/2013/11/04/bolsa-familia-Brazil-quiet-revolution), an intiative that provides families with small cash transfers in exchange for keeping children in school and completing health care visits. 
12. __Tuberculosis__: 1 or 0 for condition
13. __SMSReminder__: 0 ,1 ,2 for number of text message reminders
14. __WaitingTime__: integer number of days between when the appointment was made, and when the appointment takes place. 

```{r setup, include=FALSE}

# Set up R markdown
knitr::opts_chunk$set(echo = TRUE)

# Load in required packages
library(ggplot2)
library(plyr)
library(dplyr)
library(reshape2)
library(Hmisc)
library(GGally)

# Read in the data
no_shows <- read.csv('noshows.csv')


```

## Data Cleaning and Preliminary Investigation
Let's take a look at the structure of the dataframe to see what changes might need to be made. 
```{r}
str(no_shows)
```
From the structure of the dataframe, I can see there is a little bit of cleaning that needs to be done. First I want to change the status into an integer 0 or 1. A value of 1 will indicate that the patient did not show up as I am concerned with the varaibles that are most strongly correlated with a missed appointment. Then, I will convert the registration date and the appointment date to date objects.I decided not to maintain the time (hours:minutes:seconds) associated with the registration date for the apointment although it was available (time of day was not available for the appointment date). I converted both the appointment registration date and appointment date to date objects so I could investigate seasonal and time patterns in the data. 
```{r}

# Create numeric factors out of the two levels in status field
no_shows['Status'] <- lapply(no_shows['Status'], factor,  levels=c("Show-Up", "No-Show"), labels = c(0, 1))
# Change the factors in the the status column into 1: patient missed appointment and 0: patient attended appointment
no_shows$Status <- as.integer(as.character(no_shows$Status))

# Remove characters from dates and convert into date objects
no_shows$AppointmentDate <-gsub(pattern = "[A-Z]", replacement = " ", x = no_shows$AppointmentDate)
no_shows$AppointmentRegistrationDate <- gsub(pattern = "[A-Z]", replacement = " ", x = no_shows$AppointmentRegistrationDate)
no_shows$AppointmentDate <- as.Date(no_shows$AppointmentDate)
no_shows$AppointmentRegistrationDate <- as.Date(no_shows$AppointmentRegistrationDate)
str(no_shows)

```
Based on the update structure of the dataframe, it looks like I am on the right track.  I have a couple more modifications to make to the dataframe. I will create month, year, and day fields for the appointment and also rename the colmuns to a more consistent and readable format. 

```{r}

# Extract month, year, and day from appointment date and create new columns
no_shows <-transform(no_shows, month = format(AppointmentDate, "%m"))
no_shows <- transform(no_shows, year = format(AppointmentDate, "%Y"))
no_shows <- transform(no_shows, day = format(AppointmentDate, "%d"))

no_shows$year <- as.integer(as.character(no_shows$year))
no_shows$month <- as.integer(as.character(no_shows$month))
no_shows$day <- as.integer(as.character(no_shows$day))

# Clarify and simply column names
no_shows <- plyr::rename(no_shows, c("Age" = "age",
                               "Gender" = "gender",
                               "AppointmentRegistrationDate" = "appt_reg_date",
                               "AppointmentDate" = "appt_date",
                               "DayOfTheWeek" = "weekday",
                               "Status" = "status",
                               "Diabetes" = "diabetes",
                               "Alcoholism" = "alcoholism",
                               "Hypertension" = "hypertension",
                               "Smoker" = "smoker",
                               "Scholarship" = "welfare",
                               "Tuberculosis" = "tuberculosis",
                               "SmsReminder" = "sms_reminder",
                               "WaitingTime" = "wait",
                               "month" = "appt_month",
                               "year" = "appt_year",
                               "day" = "appt_day"))

# Look at the summary of statistics for the dataframe
summary(no_shows)

```
The summary of the no_shows dataframe reveals plenty of intriguing information as well as several errors that need to be corrected. Right away, it is clear that an age of -2 is not correct, and 113 is stretching the boundaries. However, looking at the [oldest people in the world](https://en.wikipedia.org/wiki/List_of_the_verified_oldest_people), it is plausible that 113 could be a correct age. I will filter out any negative ages and create a histogram of ages to see if there remain outliers at the upper end. Moreover, this data shows that __30.24%__ of appointments are missed based on the mean for the status field. The rates for the various conditions can also be seen, and it the most commonly coded reason for an appointment is hypertension at nearly 22%. Also, the weekends appear to be a very unpopular time for doctor's appointments in Brazil, or perhaps the clinics from which this data was drawn are not open on the weekend. Either way, I will need to keep the small sample size of appointments on the weekend in mind when I do any analysis by weekday. 

```{r}
no_shows <- filter(no_shows, age >= 0)
# Set all titles in plots to be centered
theme_update(plot.title=element_text(hjust = 0.5))

qplot(x = age, data = no_shows, color = I('black') , fill = I('blue'), binwidth = 1) + theme(legend.position="None") + 
  labs(x='Age', y="Number of Patients", title='Age Histogram') + scale_x_continuous(breaks=seq(0,110, 10))

```
The age histogram goes somewhat against my intutions. I expected that it would be bi-modal, with peaks at the youngest ages and then again at the oldest ages. However, while the largest number of patients do appear to be the youngest, there is only a slight increase into the middle ages, with a second peak around age 55 and then a steep decline into the oldest ages. Based on the visualization, there do not appear to be a large number of outliers in the upper range of the dataset. I was skeptical of the high proportion of visits from those aged 0 and decided to do some research.  Based on the description of the dataset, this is for the public sector and primary care physicians. I could not find statistics from Brazil, but based on [official statistics from the Centers for Disease Control](https://www.cdc.gov/nchs/fastats/physician-visits.htm) in the United States, children under 1 year of age make up 2.6% of all physician visits. 
```{r}
nrow(subset(no_shows, age < 1)) / nrow(no_shows) * 100
```
A simple calculation shows that 0-year olds make up 3.44% of visits in this dataset. While the frequency distribution may looked skewed, the number of bins (ages) makes it look like 0-year olds dominate the data more than is actually the case. From the research by the CDC and the visualization, I conclude that the age distribution skew is not bad data, and the outliers at the low end are good but extreme data. I will make another histogram, this time of the waiting time (or how long between the date the appointment was made, and the actual date of the appointment) to check for outliers in that field.

```{r}
qplot(x = wait, data = no_shows, color = I('black'), fill= I('darkorange'), binwidth = 5) + labs(x='Waiting Time in Days', y = 'Number of Patients', title='Waiting Time Histogram') 
```
From the summary statistics, the longest waiting time was 398 days, with a median of 8 days, and a mean of 13.84 days. From the histogram and the stats, it is clear that there are a small number of patients who wait a long time for their appointment. I wonder if the 398 days is accidentally a mistake that occured when someone choose the wrong year for their appointment! The graph is certainly long-tailed with a few outliers at the upper end of wait time. 

```{r}
nrow(subset(no_shows, wait > 365))
nrow(subset(no_shows, wait > 180))

```
It appears there is only one patient with a waiting time over one year and just over 100 (out of 300000) with a waiting time of over six months. I will exclude the patient with the waiting time over one year, but I will treat the others as good but extreme data. Here is a version of the histogram that better displays the waiting time for the majority of patients. 

```{r}
no_shows <- filter(no_shows, wait < 365)
qplot(x = wait, data = no_shows, color = I('black'), fill= I('darkorange'), binwidth = 3) + labs(x='Waiting Time in Days', y = 'Number of Patients', title='Waiting Time Histogram') + coord_cartesian(xlim=c(0,110)) + scale_x_continuous(breaks=seq(0,110,10))
```
As can be seen, the majority of patients wait less than 10 days. Based on these visualizations, and the summary statistics for the dataframe, I think that the content of the dataset is valid. I can now start investigating the relationships, or lack thereof, between the variables in the data. 

## Searching for Relationships

The first step I can take is to find the correlations between all of the columns. Once I identify the strongest correlations, I can then graph those correlations to see if the visualizations agree with the statistics. 

```{r}
ccs <- as.matrix(no_shows[,c(1, 6:17)])
rcorr(ccs, type='pearson')

```
Well, from those correlations, it appears that there are no strong predictors of whether or not a patient will miss a visit. However, I still think there are meaningful relationships to extract from the data. My approach will be to group the data by various fields and then determine if the average rate of attendance shows any relationship to different variables. The first variable will be month. Does the month affect the rate of attendance? 


```{r}
# Create a column with the year and month as decimal for potential use later
no_shows$appt_date_decimal <- no_shows$appt_year + (no_shows$appt_month / 12)
no_shows_by_date <- group_by(no_shows, appt_date_decimal)
no_shows_by_date <- dplyr::summarize(no_shows_by_date,
                              absence_rate = mean(status),
                              n = n())

no_shows_by_month <- group_by(no_shows, appt_month)
no_shows_by_month <- dplyr::summarize(no_shows_by_month,
                                      absence_rate = mean(status),
                                      n = n())

month_labels = c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul' , 'Aug', 'Sep', 'Oct', 'Nov' , 'Dec')
no_shows_by_month$month_name <- month_labels
no_shows_by_month$month_name <- factor(no_shows_by_month$month_name, levels=unique(no_shows_by_month$month_name))
ggplot(aes(x = month_name, y = absence_rate), data = no_shows_by_month) + geom_point(color = 'red')  + labs(x = 'Month of Appointment', y = 'No-Show Rate', title='No-Show Rate vs Appointment Month') + theme(axis.text.x=element_text(angle = 60, face = "bold", size = 12)) 
```
It is clear that there is no relationship present here. I would have expected the rates of no-shows to increase during the holiday season in December, and while that may be the case, it is difficult to tell if that is actually statistically significant. The scale on the y-axis is in increments of 1%, and these differences are minor. I will do the same grouping, but this time by day of the month.

```{r}
no_shows_by_day <- group_by(no_shows, appt_day)
no_shows_by_day <- dplyr::summarize(no_shows_by_day,
                                    absence_rate = mean(status),
                                    n = n())
ggplot(aes(x = appt_day, y = absence_rate), data = no_shows_by_day) + geom_point(color = 'red')  + labs(x = 'Day of Appointment', y = 'No-Show Rate', title='No-Show Rate vs Appointment Day') + scale_x_continuous(breaks=seq(1,31,1))

cor.test(no_shows_by_day$appt_day, no_shows_by_day$absence_rate)
```
Looking at the [Pearson Correlation Coefficient](http://www.statisticshowto.com/what-is-the-pearson-correlation-coefficient/), we can see that there is a slight correlation between day of the month and absence rate. As the end of the month approaches, the absence rate tends to increase although the correlation is very weak. I can do the same graph for the day of the year.

```{r}
# Load in gridExtra library for multiple plots
library(gridExtra)

p1 <- ggplot(aes(x = appt_date, y = status), data = subset(no_shows, appt_year == 2014)) + geom_point(aes(color = gender),stat = 'summary', fun.y = mean)  + labs(x = 'Appt. Date (M-D)', y = 'Absence Rate', title = 'Absence Rate vs. Day of Year 2014') + scale_x_date(date_breaks = "1 month", date_labels = "%m-%d") + theme(axis.text.x  =element_text(angle = 70, hjust = 1))

p2 <- ggplot(aes(x = appt_date, y = status), data = subset(no_shows, appt_year == 2015)) + geom_point(aes(color = gender),stat = 'summary', fun.y = mean)  + 
  labs(x = 'Appt. Date (M-D)', y = 'Absence Rate', title = 'Absence Rate vs. Day of Year 2015') + scale_x_date(date_breaks = "1 month", date_labels = "%m-%d") + theme(axis.text.x  =element_text(angle = 70, hjust = 1))

grid.arrange(p1, p2, ncol = 1)



```

Again, it looks as if there is no real correlation betwen the time of year and the absence rate for appointments. Moreover, adding in the gender does not reveal any major descrepancies. There are several days for which the absence rate is 1, which bears some more investigation. I have a hunch that these points might corespond to major holidays. However, they are not consistent across the two years, so that may not be the case. Either way, looking at the major holidays in might reveal a relationship. I sourced the holidays based on [public holidays in Brazil](http://www.officeholidays.com/countries/brazil/2015.php)

```{r}

# First for the 2015 plot

ggplot(aes(x = appt_date, y = status), data = subset(no_shows, appt_year == 2015)) +                  geom_point(aes(color = gender),stat = 'summary', fun.y = mean)  + 
  labs(x = 'Appt. Date (M-D)', y = 'Absence Rate', title = 'Absence Rate vs. Day of Year 2015') +     scale_x_date(date_breaks = "1 month", date_labels = "%m-%d") + 
  theme(axis.text.x  =element_text(angle = 70, hjust = 1)) + 
  geom_vline(aes(xintercept=(as.numeric(as.Date("2015-12-25")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2015-12-25")), y=0.6, label='Christmas'), size=3, angle=90,        vjust=-0.4, hjust=0) +
  geom_vline(aes(xintercept=(as.numeric(as.Date("2015-11-02")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2015-11-02")), y=0.6, label='All Saints Day'), size=3, angle=90,        vjust=-0.4, hjust=0) +
  geom_vline(aes(xintercept=(as.numeric(as.Date("2015-05-01")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2015-05-01")), y=0.6, label='May Day'), size=3, angle=90,        vjust=-0.4, hjust=0) + 
  geom_vline(aes(xintercept=(as.numeric(as.Date("2015-09-07")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2015-09-07")), y=0.6, label='Independence Day'), size=3,          angle=90, vjust=-0.4, hjust=0) + 
  geom_vline(aes(xintercept=(as.numeric(as.Date("2015-02-16")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2015-02-16")), y=0.6, label='Carnival'), size=3, angle=90,        vjust=-0.4, hjust=0) + 
  geom_vline(aes(xintercept=(as.numeric(as.Date("2015-04-03")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2015-04-03")), y=0.6, label='Good Friday'), size=3, angle=90,        vjust=-0.4, hjust=0) 

  
```
Again, it seems as if these holidays do not line up with higher rates of missed appointments. There is an increase in the absence rate around the beginning of July, but it does not seem to correspond to any holidays. I researched festivals in Brazil in June-July 2015, and it appears that the [Paraty International Literary Festival](http://www.telegraph.co.uk/travel/destinations/south-america/brazil/articles/brazil-events/) occured July 1-5, but I doubt that this explains the absence rate. There was not city data associated with the original dataset, so it is difficult to attempt to cross-reference specific dates with specific events. I will do the same with 2014. I remember that the [2014 World Cup was held in Brazil](http://www.fifa.com/worldcup/archive/brazil2014/), so perhaps the time around the world cup will have a higher absence rate. I will plot a few holidays and then the dates surrounding the World Cup (which lasted for a month).

```{r}
ggplot(aes(x = appt_date, y = status), data = subset(no_shows, appt_year == 2014)) +                  geom_point(aes(color = gender),stat = 'summary', fun.y = mean)  + 
  labs(x = 'Appt. Date (M-D)', y = 'Absence Rate', title = 'Absence Rate vs. Day of Year 2014') +     scale_x_date(date_breaks = "1 month", date_labels = "%m-%d") + 
  theme(axis.text.x  =element_text(angle = 70, hjust = 1)) + 
  geom_vline(aes(xintercept=(as.numeric(as.Date("2014-12-25")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2014-12-25")), y=0.6, label='Christmas'), size=3, angle=90,        vjust=-0.4, hjust=0) +
  geom_vline(aes(xintercept=(as.numeric(as.Date("2014-06-12")))), linetype = 2, color = 'green') + 
  geom_text(aes(x=(as.Date("2014-06-12")), y=0.6, label='World Cup Start'), size=3, angle=90,        vjust=-0.4, hjust=0) +
  geom_vline(aes(xintercept=(as.numeric(as.Date("2014-07-13")))), linetype = 2, color = 'green') + 
  geom_text(aes(x=(as.Date("2014-07-13")), y=0.6, label='World Cup End'), size=3, angle=90,        vjust=-0.4, hjust=0) + 
  geom_vline(aes(xintercept=(as.numeric(as.Date("2014-04-21")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2014-04-21")), y=0.6, label='Tiradentes'), size=3,          angle=90, vjust=-0.4, hjust=0) + 
  geom_vline(aes(xintercept=(as.numeric(as.Date("2014-03-04")))), linetype = 2, color = 'brown') + 
  geom_text(aes(x=(as.Date("2014-03-04")), y=0.6, label='Carnival'), size=3, angle=90,        vjust=-0.4, hjust=0) 

```

Maybe there is a slight increase in absence rate during the World Cup? I can compare the average absence rate during that period to the average absence rate over the entire length of 2014. 
```{r}
100 * mean(no_shows$status[no_shows$appt_year==2014],)
100 * mean(no_shows$status[no_shows$appt_date < "2014-07-13" & no_shows$appt_date > "2014-06-12"],)

```
Well there certainly is not a significant jump in the absence rate during the World Cup. It looks like in terms of time variability, there is no significant correlation based on the time of year, and a slight positive correlation between the absence rate of the day of the month (as the end of the month nears, the absence rate increases slightly). There is one more time variation I can look at, and that is day of the week. To reiterate, I also show the appointment days of the week count. 

```{r}
table(no_shows$weekday)

ggplot(aes(x = factor(weekday, weekdays(as.Date('1970-01-03') + 2:8)), y= status), data = no_shows)+  geom_bar(stat= 'summary', fun.y = mean, color = 'black', fill = 'navy') + 
  labs(x='Appt. Day of the Week', y = 'Absence Rate', title = 'Absence Rate vs Weekday') + 
  scale_y_continuous(breaks = seq(0.15, 0.45, 0.05)) + coord_cartesian(ylim=c(0.15,0.45))

```
Finally, it looks like there might be a trend in this data. Excluding Saturday and Sunday because of their small sample sizes, Monday and Friday have the highest absence rate. I will change the plot slightly to show the absence rate relative to the mean absence rate.

```{r}
days_of_week = c('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday') 


# Find mean of days of the week
weekday_mean = mean(no_shows$status[no_shows$weekday %in% days_of_week],)

# Create a new dataframe with statistics for weekdays only
no_shows_by_weekday <- group_by(no_shows, weekday)
no_shows_by_weekday <- summarise(no_shows_by_weekday, 
                                absence_rate = mean(status),
                                relative_absence_rate = 100*  (mean(status) - weekday_mean) / weekday_mean,
                                n = n())

no_shows_by_weekday <- filter(no_shows_by_weekday, weekday %in% days_of_week)

# Plot relative absence rate by day of the week 
ggplot(aes(x = factor(weekday, weekdays(as.Date('1970-01-03') + 2:6)),
           y= relative_absence_rate) , data = no_shows_by_weekday) +
  geom_bar(stat='identity', color='black', lwd= 1.2, fill = 'coral') + labs(x='Day of Week', y= 'Relative Absence Rate (%)', title ='Relative Absence Rate by Day of Week') + coord_cartesian(ylim=c(-5,7))
```
There finally appears to be meaningful relationship in the time variability of the data. Excluding weekends because of small sample sizes, patients are __6% more likely to miss an appointment on a Monday__ compared to average, and __4% less likely to miss an appointment on a Tuesday__. This is an actionable discovery! If patients want to keep their appointments, and if doctors want to make sure their patients show up, they should schedule their appointments during the middle three days of the week. 

I want to move away from the time variability and look at the demographic data now. In particular, I am interested in whether or not age is correlated with the absence rate. My initial guess would be that the youngest and the oldest patients tend to have lower absence rates. Meanwhile, those patients in the middle would generally be healthier and would feel more inclined to skip an appointment (everyone is convinced they are invincible in their 20s.In fact, this was one of the issues associated with the intial rollout of Obamacare. Too many young, healthy individuals [did not believe they needed insurance](https://www.usnews.com/news/articles/2016-09-07/young-invincibles-remain-elusive-for-obamacare) and therefore did not sign up for healthcare.) 





