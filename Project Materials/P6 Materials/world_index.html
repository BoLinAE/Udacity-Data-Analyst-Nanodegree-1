<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
	<style>

	h2 {
		text-align: center;
	}

	</style>

	<script type="text/javascript">

	function draw(geographic_data){
		debugger;
			"use strict";
			var margin = 75,
					width = 1600 - margin,
					height = 920 - margin;

			d3.select("body")
				.append("h2")
				.text("Emissions Explorer!")

			var svg = d3.select("body")
					.append("svg")
					.attr("width", width + margin)
					.attr("height", height + margin)
					.append("g")
					.attr("class", "map");

				var projection = d3.geo.naturalEarth()
						.scale(280)
						.translate([width / 2, height / 2]);

				var path = d3.geo.path().projection(projection);

				var map = svg.selectAll("path")
						.data(geographic_data.features)
						.enter()
						.append("path")
						.attr("d", path)
						.style("fill", "yellow")
						.style("opacity", 0.6)
						.style("stroke", "black")
						.style("stroke-width", 0.6);

				/*
				svg.selectAll("text")
						.data(geographic_data.features)
						.enter()
						.append("svg:text")
						.text(function(d) {
							return d.id;
						})
						.attr("x", function(d){
							return path.centroid(d)[0];
						})
						.attr("y", function(d){
							return path.centroid(d)[1];
						})
						.attr("text-anchor", "middle")
						.attr("font-size", "6pt");
				*/
				countries_loc = []

				for(var i=0; i<geographic_data.features.length; i+=1) {
						countries_loc[geographic_data.features[i].properties.name] = [path.centroid(geographic_data.features[i])[0], path.centroid(geographic_data.features[i])[1] ]
				}

				var years = [];
				var start_year = 1880,
					end_year = 2013,
					step = 10;

				for(var i=start_year; i<end_year; i+=step){
						years.push(i);
				}
				debugger;

		function plot_emissions(data) {
			// draw emissions dots on countries sized by emissions
			var year_idx = 0;

			var year_interval = setInterval(function() {
				plot_emissions_by_year(years[year_idx]);
				year_idx ++;

				if(year_idx >= years.length){
						clearInterval(year_interval);
				}
			}, 1000)


			radius = d3.scale.sqrt()
						.domain([0, 10200])
						.range([0,15]);

			plot_emissions_by_year(2013)

			function plot_emissions_by_year(year) {
				debugger;
				var emissions = data.filter(function (d) {return d.year === year;});
				for(var i=0; i<emissions.length; i+=1){
					countries_loc[emissions[i].country][year] = emissions[i].emissions ; 
				}
				d3.select("h2")
					.text("Emissions in " + year);

				var circles = svg.selectAll("circle")
						.data(emissions)

				circles.exit().remove();

			
				circles.enter()
					.append("circle")
					.transition()
					.duration(500)
					.attr("cx", function(d) {
						return countries_loc[d.country]['0'];
					})
					.attr("cy", function(d) {
						return countries_loc[d.country]['1'];
					})
					.attr("r", function(d) {
						return radius(d.emissions);
					});
				}
		}

		
		d3.csv("emissions_stable.csv", function(d) {
				d["country"] = d["country"];
				d["year"] = new Date(d["year"]).getUTCFullYear();
				d["emissions"] = +d["emissions"];
				return d;
		}, plot_emissions);
	}

	</script>
</head>

<body>
	<script type="text/javascript">
	d3.json("world_countries_edited.json", draw);
	</script>
</body>
</html>
